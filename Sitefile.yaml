#!/usr/bin/env sitefile
#
# Sitefile for node-sitefile document server
# A note of caution: this example config does shameless things like executing any shell
# script if you want to, like call http://localhost/clean.sh. Ymmv.
#
# Id: node-sitefile/0.0.7-dev
sitefile: 0.0.7-dev
config:
  'show-stack-trace': true
  metadata: '/data/meta'
  #debug: true # XXX: interferes with context-core prototype
  verbose: true
  domain: 'notus.lan'
  #domain: 'sitefile.wtwta.org'
  #strict-domain: true
  advertise: true
  advertise-server: true
  #aliases:
  #- 'sf-sf.wtwta.lan'
downstream: [] # Grant sitefile derefs to these remotes
upstream: # Grant CORS access (for local URL) to these hosts
- 'http://localhost'
- 'http://localhost:2000'
- 'http://localhost:2001'
- 'http://localhost:2006'
paths: # Additional routers to test local router include path extension
  routers_replace: false
  routers:
  - 'sitefile:example/routers'
# Repeated here from sitefile/sitefile.coffee to illustrate default setting:
#  packages:
#  - 'sitefile:lib/sitefile/middleware'
#  - 'sitefile:lib'
#packages:
#  - 'sitefile/context/ctx-core.coffee'
#  - 'sitefile/context/ctx-couchdb.coffee'
#  - 'cors.coffee'
#  - 'metadata.coffee'

# Here or there (package.yml) it may be nice to register the used extensions
# properly, or reflect at least their current usage, dependencies.
# Some sketchy ideas:
  #- name: context
  #  label: router functions to decorate context instances with
  #  type: context-prototype
  #  module: sitefile/context.coffee

  #- name: metadata.coffee
  #  label: route metadata middleware
  #  type: middleware
  #
  #- name: PM2
  #  type: service-container
    #proc/pm2: pm2:pm2-apps.json

#autoExport:
#  - rjs: /app/rjs

routes:

  '': redir:index

  # TODO: /_/.* -> /app/v0/#/... for HTML5 or JS clients
  '_': redir:app/v0
  '-/': redir:app/v0

  #media/style: static:build/style
  media/style/default.css: sass:sitefile-lib:style/default.sass
  media/style/palette-tango.css: sass:sitefile-lib:style/palette-tango.sass

  doc/literate: static:build/docs/docco/

  _pug: pug:example/pug-*.pug
  _stylus: stylus:example/**/*.styl
  _sass: sass:example/**/*.sass
  _coffee: coffee:example/**/*.coffee
  _markdown: markdown-it:*.md
  _markdown_1: markdown-it:example/**/*.md
  _sh: sh:example/*.sh
  _gv: graphviz:example/*.gv
  # FIXME: aliases _pu: pu:example/*.pu
  _pu: plantuml:example/*.plantuml
  _pu_dev_doc: plantuml:doc/dev/*.plantuml
  # FIXME: data.json
  #_json: data.json:example/*.json

  # Dynamic rules using glob spec
  _du: docutils:**/*.rst

  # XXX: direct command-line execution
  foo.ls: sh.ls:example/
  foo.tree: sh.tree:example/
  'sh/': sh.cmd:#

  mocha/client/*: mocha.client:#
  mocha/server/*: mocha.test:#

  # Example routes for ReadMe
  #ReadMe: docutils:ReadMe.rst # Du defaults to HTML
  #ReadMe: redir:ReadMe.html
  #ReadMe.html: docutils:ReadMe.rst
  #ReadMe.xml: docutils:ReadMe.rst

  #_rst2html: rst2html:**/*.rst
  gitflow: docutils:.gitflow.rst

  Sitefile.yaml: static:Sitefile.yaml
  Sitefile.json: sitefile:?resolve=sitefile
  Sitefile/json: redir:Sitefile.json
  Sitefile/debug: redir:Sitefile/debug/resource
  Sitefile/debug/resource/pug-opts: sitefile.pug-opts:#
  Sitefile/debug/resource: sitefile.rctx:#
  Sitefile/debug/global: redir:Sitefile/core
  Sitefile/info: sitefile.info:#
  Sitefile/core/auto: core.autocomplete:#
  Sitefile/core: core:#

  menu.json: res.load-file:sitefile:menu.yml
  sites.yml: sitefile.sites:sites.yml
  sites.json: sitefile.sites:sites.yml
  #menu-sites.json: res.xform:sites.json;var/sites-to-menu.xjson;#
  #menu-sites.json: sitefile.sites-to-menu:sites.json
  menu-sites.json: sitefile.sites-to-menu:sites.yml

  # Proxy JSON metadata, settings in options.local.npm/...
  npm/npm/latest.json: http:#
  npm/node-sitefile/latest.json: http:#

  # Look for installed package in PWD and Sitefile dir
  npm/packages/: 'static:{,sitefile:}node_modules/'

  # FIXME: display current PM2 procs and/or preconfigured apps status
  proc/pm2: pm2:pm2-apps.json

  # Some HTTP redirect handlers configured on JSON mappings
  vendor/:package.:format: http.vendor:cdn.json
  'r:ref/(.*)': http.ref:#
  'r:res/(.*)': http.res:#

  # Three seperate resources for the RequireJS client. The JSON of the jquery
  # config options, a PUG HTML template with basic structure, and the script
  # that makes the configure requirejs call.
  app/rjs-sf-v0.json: rjs.config:paths=$ref:cdn.json#/js/http/packages;shim=$ref:cdn-deps.json#/shim;deps=["require-css","cs!sf-v0"];baseUrl=/app;map=$ref:cdn-deps.json#/map
  app/rjs-sf-v0.js: rjs.main:app/rjs-sf-v0.json
  app/v0: pug:sitefile-client:sf-v0.pug
  #app/v0/base: res.load-file:sitefile-client:sf-v0.yaml
  # Serve coffee script for RequireJS client
  app/: redir:app/v0
  #app/v0-yaml:ext: rjs.boot:sitefile-client:sf-v0.yaml;name=yaml;
  'r:app/v0([^\.]*)(\..*)': rjs.boot:sitefile-client:sf-v0.yaml

  # Deconstructing prototype
  app/rjs-sf-v001.json: rjs.config:paths=$ref:cdn.json#/js/http/packages;shim=$ref:cdn-deps.json#/shim;deps=["require-css","cs!sf-v001"];baseUrl=/app;map=$ref:cdn-deps.json#/map
  app/rjs-sf-v001.js: rjs.main:app/rjs-sf-v001.json
  app/v001: pug:sitefile-client:sf-v001.pug

  #app/stencil-starter: stencil:sitefile:stencil.config.js

  'r:app/(.*).sass.css': sass:sitefile-lib:client/
  'r:app/(.*).pug.html': pug:sitefile-lib:client/
  app: static:lib/sitefile/client

  # FIXME: fonts? want to build CSS+font loading into RequireJS client
  fonts: static:node_modules/bootstrap/fonts

  # Just an instance of the example router in example/routers
  sf-example/default: sf-example:#
  sf-example/data1: sf-example.data1:#
  sf-example/data2: sf-example.data2:#

  sf-test/default: sf-test:#
  sf-test/vendor/:package.:format: sf-test:cdn.json
  'r:sf-example/(.*).coffee': sf-test:sitefile-lib:client/
  _sf_test: sf-test:example/routers/**/*.*

  local: static:public/local

  example: static:example
  # FIXME: example/: redir:example/main

  example/bookshelf/knex.sqlite/_/v1: bookshelfapi:example/bookshelf/knex.json
  example/bookshelf/knex: knex:example/bookshelf/knex.json
  # Example, get data from another endpoint, the one above?
  # XXX: example/bookshelf/knex/query-1: knex.sql:example/bookshelf/sql.coffee?knex=..


  # TODO: imagemacking processing?
  #/shadows/:path: convert.filter:**/*.png

  tools: static:tools

  _pug_server: pug:example/server-*.pug
  _pug_prism: pug:example/prism*.pug
  _pug_polymer: pug:example/polymer*.pug
  _pug_clients: pug:example/*-client*.pug

  component: static:public/components

  assets: static:assets
  favicon.ico: static:assets/favicon-file-text-8bc34a.ico

options:
  global:
    docutils:
      $ref: '#/options/global/rst2html'
    rst2html:
      link_stylesheets: true
      flags:
      - "--no-toc-backlinks"
      - '--field-name-limit=0'
      # FIXME: $ref: '#/options/global/pug/merge'
      meta:
        $ref: '#/defs/app/v0/meta'
      scripts: [] # $ref: '#/defs/scripts/default'
      stylesheets:
        $ref: '#/defs/stylesheets/default'
      clients:
        $ref: '#/defs/app/v0/clients'
    pug:
      merge:
        meta:
          $ref: '#/defs/app/v0/meta'
        scripts: [] # $ref: '#/defs/scripts/default'
        stylesheets:
          $ref: '#/defs/stylesheets/default'
        clients:
          $ref: '#/defs/app/v0/clients'
    markdown:
      pug:
        merge:
          scripts:
            $ref: '#/defs/scripts/default'
          stylesheets:
            $ref: '#/defs/stylesheets/default'
    markdown-it:
      $ref: '#/options/global/markdown'

  local:
    'app/v0':
      merge:
        $ref: '#/defs/app/v0'

    'app/v001':
      merge:
        $ref: '#/defs/app/v001'

    npm/node-sitefile/latest.json:
      spec:
        hostname: 'registry.npmjs.org'
        path: '/node-sitefile/latest'

    npm/npm/latest.json:
      spec:
        hostname: 'registry.npmjs.org'
        path: '/npm/latest'

    Sitefile/debug:
      local_var: 'fooooo'

    example/server-generated-page:
      merge:
        stylesheets:
          - /vendor/bootstrap.css
          - /vendor/bootstrap-theme.css
          - /media/style/default.css
          - /example/server-generated-stylesheet
        scripts:
          - /vendor/jquery.js
          - /vendor/bootstrap.js
          #- /vendor/require.js
          #- /vendor/source-map-support.js
          - /vendor/coffee-script.js
          - /example/server-generated-javascript
        links:
          - type: text/coffescript
            href: /example/script.coffee

    example/main-client-profiles:
      merge:
        scripts:
          $ref: '#/defs/scripts/default'
        stylesheets:
          $ref: '#/defs/stylesheets/default'
        clients:
          $ref: '#/defs/app/v0/clients'
        meta:
          $ref: '#/defs/app/v0/meta'
          #- sitefile.main: 'sitefile'
          #- sitefile-client-modules: 'cs!sf-v0/page,cs!sf-v0/tilda'

defs:
  scripts:
    default:
      - /vendor/jquery.js
      - /vendor/jquery-ui.js
      - /vendor/jquery-terminal.js
      - /vendor/jq-console.js
      #- /vendor/require.js
      #- /vendor/source-map-support.js
      - /vendor/bootstrap.js
      - /vendor/bootstrap-table.js
      - /vendor/coffee-script.js
      - /vendor/highlight-js.js
      - /vendor/highlight-js-lang-vim.js
  stylesheets:
    default:
      - url: /vendor/jquery-ui.css
      - url: /vendor/jquery-terminal.css
      - url: /vendor/bootstrap.css
      - url: /vendor/bootstrap-theme.css
      - url: /vendor/bootstrap-table.css
      - url: /media/style/default.css
        #path: build/style/default.css
      - url: /vendor/highlight-js-style-xcode.css
  app:
    v0:
      meta:
        - sitefile.main: 'sitefile'
        - sitefile-client-modules:
          - 'cs!sf-v0/page'
          - 'cs!sf-v0/storage'
          - 'cs!sf-v0/microformats/live-code'
          - 'cs!sf-v0/microformats/href-registry'
          - 'cs!sf-v0/tilda'
      clients:
        - type: require-js
          id: require-js-sitefile-v0-app
          href: /vendor/require.js
          main: /app/rjs-sf-v0.js
      stylesheets:
        $ref: '#/defs/stylesheets/default'
      scripts: []
    v001:
      clients:
        - type: require-js
          id: require-js-sitefile-v001-app
          href: /vendor/require.js
          main: /app/rjs-sf-v001.js
      stylesheets:
        $ref: '#/defs/stylesheets/default'
      scripts: []
